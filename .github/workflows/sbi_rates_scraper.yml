name: Daily SBI Rate Scraper

on:
  # Automated schedule: Runs daily at 10:00 AM UTC
  schedule:
    - cron: '0 10 * * *'
  # Allows manual triggering from the GitHub UI
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“ Checkout Repository
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Download SBI Forex Rates PDF (Advanced Spoofing)
        id: download
        run: |
          # --- Logic for Folder Structure and Filename ---
          CURRENT_YEAR=$(date '+%Y')
          FILENAME=$(date '+%d-%m-%Y-%H-%M').pdf
          OUTPUT_DIR="./sbi-tt-rates-historical/$CURRENT_YEAR"
          OUTPUT_FILE="$OUTPUT_DIR/$FILENAME"
          PDF_URL="https://www.sbi.co.in/documents/16012/1400784/FOREX_CARD_RATES.pdf"
          
          # Define Headers for advanced browser simulation
          USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36"
          ACCEPT_HEADER="text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8"
          
          # Create the necessary subdirectories (Year folder)
          mkdir -p $OUTPUT_DIR
          
          echo "Attempting to download from $PDF_URL to $OUTPUT_FILE"
          
          # ðŸš€ FINAL FIX: Use --cookie-jar and --cookie to handle cookies.
          # -c/--cookie-jar: Saves any cookies received to this file.
          # -b/--cookie: Sends cookies read from this file.
          # This simulates a browser session that receives, saves, and sends cookies.
          curl -L --fail \
               --insecure \
               -A "$USER_AGENT" \
               -H "Accept: $ACCEPT_HEADER" \
               -c /tmp/cookies.txt \
               -b /tmp/cookies.txt \
               --output $OUTPUT_FILE \
               $PDF_URL

          # Check if the download file size is reasonable (e.g., > 1000 bytes)
          SIZE=$(stat -c%s "$OUTPUT_FILE")
          if [ "$SIZE" -lt 1000 ]; then
              echo "Error: Downloaded file size is suspiciously small ($SIZE bytes). Deleting file."
              rm $OUTPUT_FILE
              exit 1
          else
              echo "Download successful. File size: $SIZE bytes."
          fi

      - name: ðŸ’¾ Configure Git and Commit Changes
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions Bot"
          
          git add sbi-tt-rates-historical
          
          if git diff --cached --exit-code; then
              echo "No new rates to commit. Nothing to do."
          else
              git commit -m "Automated: New SBI Forex Rates for $(date '+%Y-%m-%d')"
              git push
              echo "Successfully committed and pushed new rate file."
          fi
