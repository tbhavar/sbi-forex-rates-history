name: Daily SBI Rate Scraper

on:
  schedule:
    # Runs at 9:30 AM UTC, which is 3:00 PM IST (GMT+5:30)
    - cron: '30 9 * * *' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    steps:
      - name: üìù Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîê Update SSL Certificates
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates

      - name: ‚¨áÔ∏è Download SBI Forex Rates PDF (Fortified Request)
        id: download
        run: |
          # --- Logic for Folder Structure and Filename ---
          CURRENT_YEAR=$(date '+%Y')
          FILENAME=$(date '+%d-%m-%Y-%H-%M').pdf
          OUTPUT_DIR="./sbi-tt-rates-historical/$CURRENT_YEAR"
          OUTPUT_FILE="$OUTPUT_DIR/$FILENAME"
          
          PDF_URL="https://sbi.bank.in/documents/16012/1400784/FOREX_CARD_RATES.pdf"
          USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36"
          # CRITICAL: Added Referer and Accept-Language headers for reliable download
          REFERER_URL="https://www.sbi.co.in/" 
          
          mkdir -p $OUTPUT_DIR
          echo "Attempting to download from $PDF_URL to $OUTPUT_FILE"
          
          # MODIFIED CURL COMMAND
          curl -L --fail -A "$USER_AGENT" \
               -H "Referer: $REFERER_URL" \
               -H "Accept-Language: en-US,en;q=0.9" \
               --output $OUTPUT_FILE $PDF_URL

          SIZE=$(stat -c%s "$OUTPUT_FILE")
          if [ "$SIZE" -lt 1000 ]; then
              echo "Error: Downloaded file size is suspiciously small ($SIZE bytes). Deleting file."
              rm $OUTPUT_FILE
              exit 1
          else
              echo "Download successful. File size: $SIZE bytes."
          fi

      - name: üíæ Configure Git and Commit Changes
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions Bot"
          
          git add sbi-tt-rates-historical
          
          if git diff --cached --exit-code; then
              echo "No new rates to commit. Nothing to do."
          else
              git commit -m "Automated: New SBI Forex Rates for $(date '+%Y-%m-%d')"
              git push
              echo "Successfully committed and pushed new rate file."
          fi # <-- FIXED: Added missing 'fi' to close the if statement

  notification:
    # ‚ö†Ô∏è This job will ONLY run if the previous job ('scrape_and_commit') fails
    needs: scrape_and_commit
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: üìß Send Email Notification on Failure
        uses: dawidd6/action-send-mail@v3
        with:
          # Configuration for sending mail via Gmail
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          # üö® IMPORTANT: Use your actual Gmail address
          username: catanmaybhavar@gmail.com
          # üö® IMPORTANT: This password MUST be stored as a SECRET in GitHub
          password: ${{ secrets.MAIL_PASSWORD }}
          
          subject: '[FAILURE ALERT] SBI Forex Scraper Action Failed'
          # Send the email to your address
          to: catanmaybhavar@gmail.com
          # The body includes the repository and run URL for easy debugging
          body: |
            The Daily SBI Forex Rate Scraper failed to execute or commit the PDF.
            
            Repository: ${{ github.repository }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Please check the GitHub Actions logs for details on Exit Code 22 or 60.
